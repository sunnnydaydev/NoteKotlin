# åç¨‹å°ç»“

æœ¬æ–‡ä¸»è¦åå‘äºAndroidä¸­åç¨‹çš„ä½¿ç”¨å°ç»“,ä¸»è¦æœ‰å¦‚ä¸‹çŸ¥è¯†ç‚¹

- Androidä¸­ä½¿ç”¨åç¨‹çš„å‡ ç§æ–¹å¼
- ä¸ºå•¥è¦ä½¿ç”¨åç¨‹
- withContextæ–¹æ³•çš„å¦™ç”¨
- è¡¥å……

# Androidä¸­ä½¿ç”¨åç¨‹çš„å‡ ç§æ–¹å¼

###### 1ã€GlobalScope.launch{}

GlobalScopeæ˜¯ä¸€ä¸ªå•ä¾‹å®ç°ï¼Œæºç ååˆ†ç®€å•ï¼Œä¸Šä¸‹æ–‡æ˜¯EmptyCoroutineContextï¼Œæ˜¯ä¸€ä¸ªç©ºçš„ä¸Šä¸‹æ–‡ï¼Œåˆ‡ä¸åŒ…å«ä»»ä½•Jobï¼ˆä¸èƒ½é€šè¿‡jobç®¡ç†ï¼‰è¯¥ä½œç”¨åŸŸå¸¸è¢«æ‹¿æ¥åšç¤ºä¾‹ä»£ç ï¼Œç”±äº GlobalScope å¯¹è±¡æ²¡æœ‰å’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸç»„ä»¶ç›¸å…³è”ï¼Œéœ€è¦è‡ªå·±ç®¡ç† GlobalScope æ‰€åˆ›å»ºçš„ Coroutineï¼Œä¸”GlobalScopeçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ process çº§åˆ«çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬ä¸æ¨èä½¿ç”¨ GlobalScope æ¥åˆ›å»º Coroutineã€‚

###### 2ã€runBlocking {launch{}}

ä¸å»ºè®®ä½¿ç”¨,è¿™ç§æ–¹å¼é€šå¸¸é€‚ç”¨äºå•å…ƒæµ‹è¯•çš„åœºæ™¯ï¼Œè€Œä¸šåŠ¡å¼€å‘ä¸­ä¸ä¼šç”¨åˆ°è¿™ç§æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯çº¿ç¨‹é˜»å¡çš„ã€‚

###### 3ã€CoroutineScope(job).launch{}

å»ºè®®ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡jobå»ç®¡ç†å’Œæ§åˆ¶åç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚

```kotlin
        val job = Job()
        val scope = CoroutineScope(job)
        scope.launch(Dispatchers.Main) {}
        // job.cancel() // when need
```

###### 4ã€MainScope

å»ºè®®ä½¿ç”¨ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªé¡¶å±‚å‡½æ•°ï¼Œç”¨äºè¿”å›ä¸€ä¸ªä¸Šä¸‹æ–‡æ˜¯SupervisorJob() + Dispatchers.Mainçš„ä½œç”¨åŸŸï¼Œè¯¥ä½œç”¨åŸŸå¸¸è¢«ä½¿ç”¨åœ¨Activity/Fragmentï¼Œå¹¶ä¸”åœ¨ç•Œé¢é”€æ¯æ—¶è¦è°ƒç”¨fun CoroutineScope.cancel(cause: CancellationException? = null)å¯¹åç¨‹è¿›è¡Œå–æ¶ˆï¼Œè¿™æ˜¯å®˜æ–¹åº“ä¸­å¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨çš„ä¸€ä¸ªç”¨äºè·å–ä½œç”¨åŸŸçš„é¡¶å±‚å‡½æ•°ï¼Œä½¿ç”¨ç¤ºä¾‹åœ¨å®˜æ–¹åº“çš„ä»£ç æ³¨é‡Šä¸­å·²ç»ç»™å‡ºï¼Œä¸Šé¢çš„æºç ä¸­ä¹Ÿæœ‰ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯ååˆ†çš„æ–¹ä¾¿ã€‚

```kotlin
class MainActivity : AppCompatActivity(), CoroutineScope by MainScope() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        //å¼€å¯åç¨‹
        launch(Dispatchers.IO) {

        }
    }

    override fun onDestroy() {
        super.onDestroy()
        // å–æ¶ˆåç¨‹
        cancel()
    }
}
```

###### 5ã€ViewModel#viewModelScope

æ¨èä½¿ç”¨ï¼Œè¯¥æ‰©å±•å±æ€§å’Œä¸Šæ–‡ä¸­æåˆ°çš„LifecycleOwner.lifecycleScopeåŸºæœ¬ä¸€è‡´ï¼Œå®ƒæ˜¯ViewModelçš„æ‰©å±•å±æ€§ï¼Œä¹Ÿæ˜¯æ¥è‡ªAndroid çš„Lifecycle Ktxåº“ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ­¤ViewModelé”€æ¯æ—¶è‡ªåŠ¨å–æ¶ˆï¼ŒåŒæ ·ä¸ä¼šé€ æˆåç¨‹æ³„æ¼ã€‚è¯¥æ‰©å±•å±æ€§è¿”å›çš„ä½œç”¨åŸŸçš„ä¸Šä¸‹æ–‡åŒæ ·æ˜¯SupervisorJob() + Dispatchers.Main.immediate

```kotlin
/**
 * Create by SunnyDay /09/02 16:04:16
 */
class MainViewModel:ViewModel(){
    fun makeARequest(){
        viewModelScope.launch (Dispatchers.IO){

        }
    }
}
```

###### 6ã€LifecycleOwner.lifecycleScope

æ¨èä½¿ç”¨ï¼Œè¯¥æ‰©å±•å±æ€§æ˜¯ Android çš„Lifecycle Ktxåº“æä¾›çš„å…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„åç¨‹ä½œç”¨åŸŸï¼Œå®ƒä¸LifecycleOwnerçš„Lifecycleç»‘å®šï¼ŒLifecycleè¢«é”€æ¯æ—¶ï¼Œæ­¤ä½œç”¨åŸŸå°†è¢«å–æ¶ˆã€‚è¿™æ˜¯åœ¨Activity/Fragmentä¸­æ¨èä½¿ç”¨çš„ä½œç”¨åŸŸï¼Œå› ä¸ºå®ƒä¼šä¸å½“å‰çš„UIç»„ä»¶ç»‘å®šç”Ÿå‘½å‘¨æœŸï¼Œç•Œé¢é”€æ¯æ—¶è¯¥åç¨‹ä½œç”¨åŸŸå°†è¢«å–æ¶ˆï¼Œä¸ä¼šé€ æˆåç¨‹æ³„æ¼ã€‚

```kotlin
      // å¼€å¯åç¨‹
      lifecycle.coroutineScope.launch {

      }
```

# ä¸ºå•¥è¦ä½¿ç”¨åç¨‹ï¼Ÿ

è®©å¤æ‚çš„å¹¶å‘ä»£ç ï¼Œå†™èµ·æ¥å˜å¾—ç®€å•ä¸”æ¸…æ™°ï¼Œæ˜¯åç¨‹çš„ä¼˜åŠ¿ã€‚

ï¼ˆ1ï¼‰å¯¹äºå›è°ƒå¼çš„å†™æ³•ï¼Œå¦‚æœå¹¶å‘åœºæ™¯å†å¤æ‚ä¸€äº›ï¼Œä»£ç çš„åµŒå¥—å¯èƒ½ä¼šæ›´å¤šï¼Œè¿™æ ·çš„è¯ç»´æŠ¤èµ·æ¥å°±éå¸¸éº»çƒ¦ã€‚ä½†å¦‚æœä½ ä½¿ç”¨äº† Kotlin åç¨‹ï¼Œå¤šå±‚ç½‘ç»œè¯·æ±‚åªéœ€è¦è¿™ä¹ˆå†™ï¼š

```kotlin
    val job = Job()
    val scope = CoroutineScope(job)
    scope .launch(Dispatchers.Main) {               // å¼€å§‹åç¨‹ï¼šä¸»çº¿ç¨‹
        val token = api.getToken()                  // ç½‘ç»œè¯·æ±‚ï¼šIO çº¿ç¨‹
        val user = api.getUser(token)               // ç½‘ç»œè¯·æ±‚ï¼šIO çº¿ç¨‹
        nameTv.text = user.name                     // æ›´æ–° UIï¼šä¸»çº¿ç¨‹
}
```

ï¼ˆ2ï¼‰å¦‚æœé‡åˆ°çš„åœºæ™¯æ˜¯å¤šä¸ªç½‘ç»œè¯·æ±‚éœ€è¦ç­‰å¾…æ‰€æœ‰è¯·æ±‚ç»“æŸä¹‹åå†å¯¹ UI è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœä½¿ç”¨å›è°ƒå¼çš„å†™æ³•ï¼Œé‚£ä¹ˆä»£ç å¯èƒ½å†™èµ·æ¥æ—¢å›°éš¾åˆåˆ«æ‰­ã€‚äºæ˜¯æˆ‘ä»¬å¯èƒ½ä¼šé€‰æ‹©å¦¥åï¼Œé€šè¿‡å…ˆåè¯·æ±‚ä»£æ›¿åŒæ—¶è¯·æ±‚ï¼š

```kotlin
    // åŠŸèƒ½æ–¹æ³•
    api.getAvatar(user, callback)
    api.getCompanyLogo(user, callback)
    // ä½¿ç”¨
    api.getAvatar(user) { avatar ->
    api.getCompanyLogo(user) { logo ->
    show(merge(avatar, logo))
    }
 }
```

åœ¨å®é™…å¼€å‘ä¸­å¦‚æœè¿™æ ·å†™ï¼Œæœ¬æ¥èƒ½å¤Ÿå¹¶è¡Œå¤„ç†çš„è¯·æ±‚è¢«å¼ºåˆ¶é€šè¿‡ä¸²è¡Œçš„æ–¹å¼å»å®ç°ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç­‰å¾…æ—¶é—´é•¿äº†ä¸€å€ï¼Œä¹Ÿå°±æ˜¯æ€§èƒ½å·®äº†ä¸€å€ã€‚

ï¼ˆ3ï¼‰è€Œå¦‚æœä½¿ç”¨åç¨‹ï¼Œå¯ä»¥ç›´æ¥æŠŠä¸¤ä¸ªå¹¶è¡Œè¯·æ±‚å†™æˆä¸Šä¸‹ä¸¤è¡Œï¼Œæœ€åå†æŠŠç»“æœè¿›è¡Œåˆå¹¶å³å¯

```kotlin
coroutineScope.launch(Dispatchers.Main) {
    //            ğŸ‘‡  async å‡½æ•°ä¹‹åå†è®²
    val avatar = async { api.getAvatar(user) }    // è·å–ç”¨æˆ·å¤´åƒ
    val logo = async { api.getCompanyLogo(user) } // è·å–ç”¨æˆ·æ‰€åœ¨å…¬å¸çš„ logo
    val merged = suspendingMerge(avatar, logo)    // åˆå¹¶ç»“æœ
    //                  ğŸ‘†
    show(merged) // æ›´æ–° UI
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå³ä¾¿æ˜¯æ¯”è¾ƒå¤æ‚çš„å¹¶è¡Œç½‘ç»œè¯·æ±‚ï¼Œä¹Ÿèƒ½å¤Ÿé€šè¿‡åç¨‹å†™å‡ºç»“æ„æ¸…æ™°çš„ä»£ç ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ `suspendingMerge` å¹¶ä¸æ˜¯åç¨‹ API ä¸­æä¾›çš„æ–¹æ³•ï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªå¯ã€ŒæŒ‚èµ·ã€çš„ç»“æœåˆå¹¶æ–¹æ³•ã€‚

# withContextæ–¹æ³•çš„å¦™ç”¨

###### 1ã€æ¥ä¸ªä¾‹å­

ä½ è¦åœ¨åå°æ‰§è¡Œä»»åŠ¡ï¼Ÿåˆ‡çº¿ç¨‹

```kotlin
launch(Dispatchers.IO) {
    val image = getImage(imageId)
}
```

ç„¶åéœ€è¦åœ¨å‰å°æ›´æ–°ç•Œé¢ï¼Ÿå†åˆ‡ï¼

```kotlin
coroutineScope.launch(Dispatchers.IO) {
    val image = getImage(imageId) // åå°æ‰§è¡Œ
    launch(Dispatchers.Main) {
        avatarIv.setImageBitmap(image) // å‰å°æ‰§è¡Œ
    }
}
```

###### 2ã€withContext 

å¦‚æœåªæ˜¯ä½¿ç”¨ `launch` å‡½æ•°ï¼Œåç¨‹å¹¶ä¸èƒ½æ¯”çº¿ç¨‹åšæ›´å¤šçš„äº‹ã€‚ä¸è¿‡åç¨‹ä¸­å´æœ‰ä¸€ä¸ªå¾ˆå®ç”¨çš„å‡½æ•°ï¼š`withContext` ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åˆ‡æ¢åˆ°æŒ‡å®šçš„çº¿ç¨‹ï¼Œå¹¶åœ¨é—­åŒ…å†…çš„é€»è¾‘æ‰§è¡Œç»“æŸä¹‹åï¼Œè‡ªåŠ¨æŠŠçº¿ç¨‹åˆ‡å›å»ç»§ç»­æ‰§è¡Œã€‚é‚£ä¹ˆå¯ä»¥å°†ä¸Šé¢çš„ä»£ç å†™æˆè¿™æ ·ï¼š

```kotlin
coroutineScope.launch(Dispatchers.Main) {      // ğŸ‘ˆ åœ¨ UI çº¿ç¨‹å¼€å§‹
    val image = withContext(Dispatchers.IO) {  // ğŸ‘ˆ åˆ‡æ¢åˆ° IO çº¿ç¨‹ï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæˆååˆ‡å› UI çº¿ç¨‹
        getImage(imageId)                      // ğŸ‘ˆ å°†ä¼šè¿è¡Œåœ¨ IO çº¿ç¨‹
    }
    avatarIv.setImageBitmap(image)             // ğŸ‘ˆ å›åˆ° UI çº¿ç¨‹æ›´æ–° UI
}
```

è¿™ç§å†™æ³•çœ‹ä¸Šå»å¥½åƒå’Œåˆšæ‰é‚£ç§åŒºåˆ«ä¸å¤§ï¼Œä½†å¦‚æœä½ éœ€è¦é¢‘ç¹åœ°è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œè¿™ç§å†™æ³•çš„ä¼˜åŠ¿å°±ä¼šä½“ç°å‡ºæ¥ã€‚å¯ä»¥å‚è€ƒä¸‹é¢çš„å¯¹æ¯”ï¼š

```kotlin
ğŸï¸
// ç¬¬ä¸€ç§å†™æ³•
coroutineScope.launch(Dispatchers.IO) {
    ...
    launch(Dispatchers.Main){
        ...
        launch(Dispatchers.IO) {
            ...
            launch(Dispatchers.Main) {
                ...
            }
        }
    }
}

// é€šè¿‡ç¬¬äºŒç§å†™æ³•æ¥å®ç°ç›¸åŒçš„é€»è¾‘
coroutineScope.launch(Dispatchers.Main) {
    ...
    withContext(Dispatchers.IO) {
        ...
    }
    ...
    withContext(Dispatchers.IO) {
        ...
    }
    ...
}
```

ç”±äºå¯ä»¥"è‡ªåŠ¨åˆ‡å›æ¥"ï¼Œæ¶ˆé™¤äº†å¹¶å‘ä»£ç åœ¨åä½œæ—¶çš„åµŒå¥—ã€‚ç”±äºæ¶ˆé™¤äº†åµŒå¥—å…³ç³»ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠ `withContext` æ”¾è¿›ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°é‡Œé¢ï¼š

```kotlin
ğŸï¸
launch(Dispatchers.Main) {              // ğŸ‘ˆ åœ¨ UI çº¿ç¨‹å¼€å§‹
    val image = getImage(imageId)
    avatarIv.setImageBitmap(image)     // ğŸ‘ˆ æ‰§è¡Œç»“æŸåï¼Œè‡ªåŠ¨åˆ‡æ¢å› UI çº¿ç¨‹
}
//                               ğŸ‘‡
fun getImage(imageId: Int) = withContext(Dispatchers.IO) {
    ...
}
```

# è¡¥å……

###### 1ã€ä½¿ç”¨suspendCoroutineç®€åŒ–å›è°ƒ

suspendCoroutine å‡½æ•°ä¼šå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹æ‰§è¡Œlambdaè¡¨è¾¾å¼ä¸­çš„ä»£ç .Lambdaè¡¨è¾¾å¼çš„å‚æ•°æ˜¯ä¸€ä¸ªContinuationå‚æ•°,è°ƒç”¨å®ƒçš„resumeæ–¹æ³•æˆ–resumeWithExceptionå¯ä»¥è®©åç¨‹æ¢å¤æ‰§è¡Œã€‚

```kotlin
fun main() = runBlocking<Unit> {
    launch {
        val response = sendRequest("https://www.baidu.com/")
        println("ç½‘ç»œè¯·æ±‚ç»“æœ : $response")
    }

}

suspend fun sendRequest(address: String): String {
    // lambda è¿è¡Œåœ¨å·¥ä½œçº¿ç¨‹ä¸­
    return suspendCoroutine { continuation ->
        val response = "result"                // å‡è®¾è¿™é‡Œåšäº†ç½‘ç»œè¯·æ±‚å¹¶ä¸”è¿”å›ç»“æœ
         continuation.resume(response)         // å›è°ƒè¯·æ±‚æˆåŠŸç»“æœ
         //continuation.resumeWithException(e) // å›è°ƒè¯·æ±‚å¤±è´¥ç»“æœ
    }
}

```

[å‚è€ƒ1](https://rengwuxian.com/kotlin-coroutines-1/)

[å‚è€ƒ2](https://juejin.cn/post/6950616789390721037#heading-19)